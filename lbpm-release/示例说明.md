# LBPM 示例使用指南

本文档详细介绍 LBPM 项目中所有示例的文件说明和运行方法。

## 目录

- [示例分类](#示例分类)
  - [基础验证示例](#基础验证示例)
  - [两相流示例](#两相流示例)
  - [多孔介质流动](#多孔介质流动)
  - [特殊几何与边界条件](#特殊几何与边界条件)
  - [数据处理工具](#数据处理工具)
  - [HPC集群配置](#hpc集群配置)
- [运行示例的通用步骤](#运行示例的通用步骤)

---
---

## 示例分类

### 基础验证示例

#### 1. Bubble - 气泡模拟

**目录:** `example/Bubble/`

**文件说明:**
- `generate_bubble.py` - 生成 80×80×80 球形气泡几何
- `bubble_final.db` - LBPM 配置文件（可直接运行）
- `bubble_80x80x80.raw` - 生成的几何数据（二进制）
- `run_bubble.sh` - 快速运行脚本
- `CreateBubble.py` / `CreateCell.py` - 其他几何生成脚本
- `README_CN.md` - 详细中文说明

**用途:**
- 验证 LBPM 安装
- 测试两相流颜色模型基本功能
- 学习如何设置简单的两相流模拟

**运行步骤:**
```bash
cd example/Bubble

# 1. 生成几何文件
python3 generate_bubble.py

# 2. 运行模拟（单进程）
lbpm_color_simulator bubble_final.db

# 或使用 MPI 并行（4进程）
mpirun -np 4 lbpm_color_simulator bubble_final.db
```

**预期输出:**
- `timelog.csv` - 时间步统计
- `minkowski.csv` - Minkowski 几何测量
- `vis*/` - SILO 可视化数据
- 运行时间约 0.06 秒（200 时间步）

---

#### 2. ConstrainedBubble - 受限气泡

**目录:** `example/ConstrainedBubble/`

**文件说明:**
- `Domain.in` - 域设置文件
- `Color.in` - 颜色模型参数
- `BlobSize.in` - 气泡尺寸配置

**用途:** 测试气泡在受限空间中的行为

**运行步骤:**
```bash
cd example/ConstrainedBubble
mpirun -np 1 lbpm_color_simulator input.db
```

---

#### 3. Droplet - 液滴模拟

**目录:** `example/Droplet/`

**文件说明:**
- `CreateDroplet.py` - 生成液滴几何（80×80×40）
- `CreateDroplet.ipynb` - Jupyter notebook 版本
- `input.db` - 配置文件

**用途:** 模拟液滴在固体表面的铺展和接触角

**运行步骤:**
```bash
cd example/Droplet

# 1. 生成液滴几何
python3 CreateDroplet.py

# 2. 运行模拟
mpirun -np 1 lbpm_color_simulator input.db
```

**特点:** 包含固体底面（底部4层），用于研究接触角和润湿性

---

#### 4. DropletCoalescence - 液滴聚并

**目录:** `example/DropletCoalescence/`

**文件说明:**
- `Droplets.py` - 生成多个液滴几何
- `input.db` - 配置文件

**用途:** 研究多个液滴相互接触后的合并过程

**运行步骤:**
```bash
cd example/DropletCoalescence
python3 Droplets.py
mpirun -np 1 lbpm_color_simulator input.db
```

---

### 两相流示例

#### 5. Piston - 活塞驱替

**目录:** `example/Piston/`

**文件说明:**
- `Piston.py` - 生成活塞驱替几何
- `Piston.sh` - 运行脚本
- `input.db` - 配置文件
- `poiseuille.db` - Poiseuille 流动配置
- `vis*/` - 各时间步可视化数据

**用途:**
- 验证界面捕捉精度
- 测量动态接触角
- 与理论模型对比验证

**运行步骤:**
```bash
cd example/Piston

# 1. 生成几何
python3 Piston.py

# 2. 运行模拟
bash Piston.sh
# 或手动运行
mpirun -np 1 lbpm_color_simulator input.db
```

---

#### 6. CornerFlow - 角流动

**目录:** `example/CornerFlow/`

**文件说明:**
- `CornerFlow.py` - 生成角流动几何
- `input.db` - 配置文件
- `vis*/` - 可视化输出目录

**用途:** 研究流体在角落/楔形空间中的毛细流动

**运行步骤:**
```bash
cd example/CornerFlow
python3 CornerFlow.py
mpirun -np 1 lbpm_color_simulator input.db
```

---

#### 7. Plates - 平行板

**目录:** `example/Plates/`

**文件说明:**
- `ParallelPlates.py` - 生成平行板几何（96×24×24）
- `MixedWet.sh` - 混合润湿性运行脚本
- `input.db` - 配置文件

**用途:**
- 模拟两相流在平行板间的流动
- 测试不同润湿性边界条件

**运行步骤:**
```bash
cd example/Plates

# 1. 生成几何
python3 ParallelPlates.py

# 2. 运行标准模拟
mpirun -np 1 lbpm_color_simulator input.db

# 3. 运行混合润湿性模拟
bash MixedWet.sh
```

**几何特征:**
- 顶部和底部为固体壁面（标签 -1 和 -2）
- 中间区域（x=12-72）初始化为非湿相

---

#### 8. SquareTube - 方管流动

**目录:** `example/SquareTube/`

**文件说明:**
- `SquareTube.py` - 生成方形管道几何
- `MixedWet.sh` - 混合润湿性脚本
- `input.db` - 配置文件

**用途:** 方形截面管道中的两相流动

**运行步骤:**
```bash
cd example/SquareTube
python3 SquareTube.py
mpirun -np 1 lbpm_color_simulator input.db
```

---

#### 9. InkBottle - 墨水瓶效应

**目录:** `example/InkBottle/`

**文件说明:**
- `InkBottle.R` - R 语言几何生成脚本

**用途:** 模拟墨水瓶孔隙结构中的滞后效应

**运行步骤:**
```bash
cd example/InkBottle
Rscript InkBottle.R
mpirun -np 1 lbpm_color_simulator input.db
```

---

### 多孔介质流动

#### 10. drainage - 排水过程

**目录:** `example/drainage/`

**文件说明:**
- `setup-drain.py` - 排水模拟设置脚本
- `eos-MorphDrain.pbs` - EOS 集群作业脚本

**用途:** 模拟多孔介质中的排水（非湿相入侵）过程

**运行步骤:**
```bash
cd example/drainage
python3 setup-drain.py
# 根据生成的配置运行模拟
mpirun -np 4 lbpm_color_simulator input.db
```

---

#### 11. imbibition - 渗吸过程

**目录:** `example/imbibition/`

**文件说明:**
- `setup-imbibition.py` - 渗吸模拟设置
- `InitializeImbibition.sh` - 初始化脚本

**用途:** 模拟湿相入侵多孔介质的渗吸过程

**运行步骤:**
```bash
cd example/imbibition
bash InitializeImbibition.sh
python3 setup-imbibition.py
mpirun -np 4 lbpm_color_simulator input.db
```

---

#### 12. relperm - 相对渗透率

**目录:** `example/relperm/`

**文件说明:**
- `dist_func_utils.py` - 距离函数工具
- `morph_getpores.py` - 提取孔隙结构
- `morph_reducepores.py` - 简化孔隙网络

**用途:**
- 计算多孔介质相对渗透率曲线
- 形态学分析

**运行步骤:**
```bash
cd example/relperm
# 1. 提取孔隙
python3 morph_getpores.py input.db

# 2. 简化孔隙网络
python3 morph_reducepores.py

# 3. 运行相对渗透率计算
mpirun -np 8 lbpm_color_simulator input.db
```

---

#### 13. Sph125 / Sph1896 - 球形填充床

**目录:** `example/Sph125/`, `example/Sph1896/`

**文件说明:**
- `input.db` - 配置文件
- `pack.out` - 球心位置数据
- `Simulation.sh` - 运行脚本（Sph1896）

**用途:**
- 随机填充球体的多孔介质模拟
- Sph125: 125 个球
- Sph1896: 1896 个球（更大规模）

**运行步骤:**
```bash
# Sph125 示例
cd example/Sph125
mpirun -np 8 lbpm_color_simulator input.db

# Sph1896 示例（推荐更多进程）
cd example/Sph1896
bash Simulation.sh
# 或手动运行
mpirun -np 27 lbpm_color_simulator input.db
```

---

#### 14. MicroModel - 微观模型

**目录:** `example/MicroModel/`

**文件说明:**
- `FullMicromodel.discs` - 圆盘堆积数据
- `ReadDiscPack.R` - 读取圆盘数据的 R 脚本
- `GenerateCases.sh` - 批量生成测试用例

**用途:** 2D 微观模型流动模拟（圆盘阵列）

**运行步骤:**
```bash
cd example/MicroModel
bash GenerateCases.sh
# 根据生成的配置运行
mpirun -np 4 lbpm_color_simulator input.db
```

---

#### 15. Juanes - Juanes 基准问题

**目录:** `example/Juanes/`

**文件说明:**
- `FullMicromodel.discs` - 圆盘堆积
- `ReadDiscPack.R` - R 脚本
- `GenerateCases.sh` - 生成脚本

**用途:** 重现 Juanes 等人的经典两相流基准测试

**运行步骤:**
```bash
cd example/Juanes
bash GenerateCases.sh
mpirun -np 4 lbpm_color_simulator input.db
```

---

### 特殊几何与边界条件

#### 16. NonNewtonianChannelFlow - 非牛顿流体

**目录:** `example/NonNewtonianChannelFlow/`

**文件说明:**
- `Domain.in` - 域配置
- `Permeability.in` - 渗透率配置
- `README.md` - 说明文档

**用途:** 非牛顿流体在通道中的流动

**运行步骤:**
```bash
cd example/NonNewtonianChannelFlow

# 1. 预处理（设置通道宽度）
export TUBEWIDTH=20
export LAYERWIDTH=0
mpirun -np 1 lbpm_plates_pp $TUBEWIDTH $LAYERWIDTH

# 2. 运行渗透率模拟
mpirun -np 1 lbpm_permeability_simulator input.db
```

---

#### 17. PlaneMembrane - 平面膜

**目录:** `example/PlaneMembrane/`

**文件说明:**
- `plane_membrane.py` - 生成平面膜几何
- `plane_membrane.db` - 配置文件

**用途:** 模拟半透膜/界面传质

**运行步骤:**
```bash
cd example/PlaneMembrane
python3 plane_membrane.py
mpirun -np 1 lbpm_color_simulator plane_membrane.db
```

---

#### 18. SingleCell - 单细胞电化学

**目录:** `example/SingleCell/`

**文件说明:**
- `Bacterium.swc` - 细胞形态数据（SWC 格式）
- `Bacterium.db` - 细胞几何配置
- `NaCl-cell.py` - 生成 NaCl 溶液配置
- `NaCl.db` - 电解质配置

**用途:**
- 单细胞尺度的电化学模拟
- 离子传输和电动力学

**运行步骤:**
```bash
cd example/SingleCell
python3 NaCl-cell.py
mpirun -np 1 lbpm_nernst_planck_cell_simulator NaCl.db
```

---

#### 19. DiscPack - 圆盘堆积

**目录:** `example/DiscPack/`

**文件说明:**
- `DiscPack.ipynb` - Jupyter notebook
- `discs.csv` - 圆盘位置和半径数据

**用途:** 生成和可视化 2D 圆盘随机堆积

**运行步骤:**
```bash
cd example/DiscPack
jupyter notebook DiscPack.ipynb
```

---

### 数据处理工具

#### 20. Python - Python 工具集

**目录:** `example/Python/`

**核心脚本:**

| 脚本 | 功能 |
|------|------|
| `LBPM_Preprocessing_INPUT_writer_utils.py` | 输入文件生成工具 |
| `LBPM_Preprocessing_ReadFromRawCTimageData.py` | 从 RAW/CT 图像读取 |
| `LBPM_Preprocessing_ReadFromProcessedSegImage.py` | 从分割图像读取 |
| `LBPM_WIA_OutputData_Extraction_Preprocessing.py` | WIA 输出数据提取 |
| `LBPM_WIA_OutputData_Postprocessing_utils.py` | WIA 后处理工具 |
| `LBPM_WIA_OutputData_Reconstruction.py` | WIA 数据重建 |
| `LBPM_Postprocess_ID_SignDist_Recon.py` | ID 和有符号距离场重建 |
| `lbpm_morph_generate_configs.py` | 形态学配置生成 |
| `lbpm_segment_phase_field.py` | 相场分割 |
| `lbpm_segmented_decomp_and_pp.py` | 分割后的区域分解 |

**用途:**
- 数据预处理
- 后处理分析
- 可视化数据生成

---

#### 21. R - R 语言工具

**目录:** `example/R/`

**脚本:**
- `DefsTCAT.R` - TCAT 定义和工具函数
- `Piston.R` - 活塞数据分析
- `equil-pc-sw.R` - 平衡毛细压力-饱和度曲线

**用途:** 统计分析和绘图

---

#### 22. Segmented - 分割图像处理

**目录:** `example/Segmented/`

**文件说明:**
- `Domain.in` - 域配置
- `Segmented.in` - 分割参数

**用途:** 处理已分割的 CT/显微图像

**运行步骤:**
```bash
cd example/Segmented
mpirun -np 4 lbpm_segmented_pp input.db
```

---

#### 23. SegmentingImage - 图像分割

**目录:** `example/SegmentingImage/`

**文件说明:**
- `SegmentMicromodelTiff_Group.py` - 批量分割 TIFF 图像
- `SegmentMicromodelTiff_utils.py` - 分割工具函数
- `Check_SignDist_and_ID.py` - 检查有符号距离和标识

**用途:** 将显微图像分割为孔隙/固相

**运行步骤:**
```bash
cd example/SegmentingImage
python3 SegmentMicromodelTiff_Group.py
```

---

#### 24. Tiff - TIFF 图像预处理

**目录:** `example/Tiff/`

**文件说明:**
- `TiffPreprocessor.py` - TIFF 预处理器
- `eos-REV.pbs` - REV（Representative Elementary Volume）作业脚本

**用途:**
- 处理 TIFF 格式的 CT 图像
- 准备用于 LBPM 的输入数据

**运行步骤:**
```bash
cd example/Tiff
python3 TiffPreprocessor.py <input.tif> <output.raw>
```

---

#### 25. uCT - 微CT图像

**目录:** `example/uCT/`

**文件说明:**
- `input.db` - 配置文件
- `eos-uCT.pbs` - EOS 作业脚本

**用途:** 直接从微CT扫描数据运行模拟

**运行步骤:**
```bash
cd example/uCT
mpirun -np 8 lbpm_color_simulator input.db
```

---

### HPC集群配置

#### 26. systems - 各HPC系统配置

**目录:** `example/systems/`

**子目录:**

##### summit - ORNL Summit 超算
**文件:**
- `summit-test-3600g.lsf` - 3600 GPU 测试作业
- `summit-test-1200g.lsf` - 1200 GPU 测试作业
- `summit-spheres-1g.lsf` - 单 GPU 球体测试
- `GeneratePeriodicCase.sh` - 生成周期性测试用例

##### crusher - ORNL Crusher (AMD GPU)
**子目录:**
- `A2-8GPU/` - A2 问题 8 GPU 配置
- `Dense-8GPU/` - 密集填充 8 GPU

##### spock - ORNL Spock (测试系统)
**文件:**
- `Spock.sh` - 运行脚本
- `GenerateSphereTest.sh` - 生成球体测试
- `sphere322.db`, `test.db` - 测试配置

##### huckleberry - Huckleberry 集群
**文件:**
- `lbpm-8p100.slurm` - 8进程100步作业
- `preprocess.slurm` - 预处理作业

**用途:**
- 提供各 HPC 系统的作业脚本模板
- 大规模并行计算示例

---

#### 27. Workflow - 工作流示例

**目录:** `example/Workflow/`

**文件说明:**
- `ComputeSaturation.py` - 计算饱和度
- `HelperFunctions.R` - R 辅助函数
- `Titan/` - Titan 超算工作流
- `Eos/` - EOS 系统工作流
  - `eos-Preprocess.pbs` - 预处理
  - `eos-Decomp.pbs` - 区域分解
  - `eos-MorphDrain.pbs` - 形态学排水
  - `eos-MorphOpen.pbs` - 形态学开运算
  - `eos-Random.pbs` - 随机生成

**用途:**
- 完整的模拟工作流示例
- 从预处理到后处理的自动化流程

---

## 运行示例的通用步骤

### 基本流程

```bash
# 1. 进入示例目录
cd example/<示例名>/

# 2. 生成几何（如果有 Python/R 脚本）
python3 <生成脚本>.py
# 或
Rscript <生成脚本>.R

# 3. 运行模拟
mpirun -np <进程数> <模拟器> <配置文件>

# 常见示例:
mpirun -np 1 lbpm_color_simulator input.db
mpirun -np 4 lbpm_permeability_simulator input.db
mpirun -np 8 lbpm_greyscale_simulator input.db
```

### 选择合适的进程数

| 域大小 | 推荐进程数 | 说明 |
|--------|-----------|------|
| < 100³ | 1-4 | 小规模测试 |
| 100³ - 200³ | 4-8 | 中等规模 |
| 200³ - 400³ | 8-27 | 较大规模 |
| > 400³ | 27-64+ | 大规模计算 |

**注意:** 进程数应尽量能被域尺寸整除（如 2×2×2=8, 3×3×3=27）

### 查看输出

**标准输出文件:**
- `timelog.csv` - 每个时间步的统计信息
- `minkowski.csv` - Minkowski 泛函（几何测量）
- `solid.csv` - 固相信息
- `phase.csv` - 相信息
- `vis*/` - 可视化目录（SILO 格式）

**使用 VisIt 或 ParaView 可视化:**
```bash
visit vis*/summary.silo
# 或
paraview --data=vis*/summary.silo
```

### 常见问题排查

#### 1. 找不到可执行文件
```bash
# 检查 PATH
echo $PATH | grep LBPM

# 手动添加
export PATH=~/work/LBPM/build/bin:$PATH
```

#### 2. 缺少几何文件
```bash
# 运行生成脚本
python3 generate_*.py
# 或
Rscript *.R
```

#### 3. MPI 错误
```bash
# 检查 MPI 安装
which mpirun
mpirun --version

# 减少进程数重试
mpirun -np 1 lbpm_color_simulator input.db
```

#### 4. 内存不足
```bash
# 减小域尺寸或增加进程数分散内存
# 编辑 input.db 或 Domain.in 中的 N 参数
```

---

## 推荐学习路径

### 初学者
1. **Bubble** - 最简单的两相流验证
2. **Droplet** - 理解接触角和润湿性
3. **Plates** - 学习边界条件设置

### 中级用户
4. **Piston** - 动态接触角测量
5. **Sph125** - 多孔介质基础
6. **drainage/imbibition** - 典型的多孔介质流动

### 高级用户
7. **relperm** - 相对渗透率计算
8. **MicroModel/Juanes** - 复杂几何和基准问题
9. **systems/** - HPC 大规模并行计算

---

## 参考文档

- **主文档:** `/home/serenNan/work/LBPM/CLAUDE.md`
- **构建说明:** `/home/serenNan/work/LBPM/README.md`
- **Bubble 详细教程:** `example/Bubble/README_CN.md`
- **API 文档:** `docs/` 目录（需构建）

---

**最后更新:** 2025-11-23
**LBPM 版本:** Master branch (955b8cdc)
