# LBPM 编译指南

本文档提供 LBPM (Lattice Boltzmann Methods for Porous Media) 项目的完整编译说明。

## 目录

- [系统要求](#系统要求)
- [依赖安装](#依赖安装)
- [编译步骤](#编译步骤)
- [GPU 支持](#gpu-支持)
- [常见问题](#常见问题)
- [测试验证](#测试验证)

---

## 系统要求

### 操作系统
- **Linux** (Ubuntu, CentOS, RHEL 等)
- 不支持 Windows 和 macOS（可使用 WSL2 或 Docker）

### 必需依赖

| 依赖项 | 版本要求 | 说明 |
|--------|---------|------|
| **CMake** | ≥ 3.9 | 构建系统 |
| **MPI** | OpenMPI 或 MPICH | 并行计算框架 |
| **HDF5** | ≥ 1.8 | 数据输出格式 |
| **SILO** | 任意版本 | 可视化数据格式 |
| **GCC** | 支持 C++14 | C++ 编译器 |

### 可选依赖

| 依赖项 | 说明 |
|--------|------|
| **CUDA** | NVIDIA GPU 加速 |
| **HIP** | AMD GPU 加速 |
| **NetCDF** | 网络通用数据格式 |
| **TimerUtility** | 性能分析工具 |

---

## 依赖安装

### Ubuntu/Debian 系统

```bash
# 更新软件源
sudo apt update

# 安装基础开发工具
sudo apt install build-essential cmake git

# 安装 MPI
sudo apt install openmpi-bin libopenmpi-dev

# 安装 HDF5
sudo apt install libhdf5-dev libhdf5-openmpi-dev

# 安装 SILO（可选）
sudo apt install libsilo-dev

# 安装 NetCDF（可选）
sudo apt install libnetcdf-dev
```

### CentOS/RHEL 系统

```bash
# 安装开发工具
sudo yum groupinstall "Development Tools"
sudo yum install cmake git

# 安装 MPI
sudo yum install openmpi openmpi-devel
# 加载 MPI 环境
module load mpi/openmpi-x86_64

# 安装 HDF5
sudo yum install hdf5-devel hdf5-openmpi-devel

# SILO 需要手动编译或使用 EPEL 源
```

### 验证依赖安装

```bash
# 检查编译器
gcc --version
g++ --version

# 检查 MPI
which mpicc mpicxx
mpicc --version

# 检查 CMake
cmake --version

# 检查 HDF5
h5cc -showconfig | grep Version
```

---

## 编译步骤

### 方法一：快速编译（推荐新手）

```bash
# 1. 克隆或进入源码目录
cd /path/to/LBPM

# 2. 创建独立的构建目录（重要！）
mkdir -p ../LBPM-build
cd ../LBPM-build

# 3. 配置项目
cmake \
    -D CMAKE_C_COMPILER=mpicc \
    -D CMAKE_CXX_COMPILER=mpicxx \
    -D CMAKE_CXX_STANDARD=14 \
    -D CMAKE_BUILD_TYPE=Release \
    -D USE_CUDA=0 \
    -D USE_HIP=0 \
    -D USE_SILO=1 \
    -D USE_NETCDF=0 \
    -D USE_TIMER=0 \
    /path/to/LBPM

# 4. 编译（使用 4 线程）
make -j4

# 5. 安装
make install

# 6. 运行测试
ctest
```

### 方法二：使用配置脚本（推荐）

创建配置脚本 `configure.sh`:

```bash
#!/bin/bash

# 清理旧配置
rm -rf CMake*

# 源码目录
SOURCE_DIR=/path/to/LBPM

# CMake 配置
cmake \
    -D CMAKE_C_COMPILER=mpicc \
    -D CMAKE_CXX_COMPILER=mpicxx \
    -D CMAKE_C_FLAGS="-O3 -fPIC" \
    -D CMAKE_CXX_FLAGS="-O3 -fPIC" \
    -D CMAKE_CXX_STANDARD=14 \
    -D MPIEXEC=mpirun \
    -D USE_EXT_MPI_FOR_SERIAL_TESTS=TRUE \
    -D CMAKE_BUILD_TYPE=Release \
    -D USE_CUDA=0 \
    -D USE_HIP=0 \
    -D USE_SILO=1 \
    -D USE_NETCDF=0 \
    -D USE_TIMER=0 \
    ${SOURCE_DIR}

# 编译和安装
make -j4 && make install
```

执行脚本：

```bash
chmod +x configure.sh
./configure.sh
```

### 方法三：指定依赖库路径

如果系统库不在标准路径，需要手动指定：

```bash
cmake \
    -D CMAKE_C_COMPILER=/opt/openmpi/bin/mpicc \
    -D CMAKE_CXX_COMPILER=/opt/openmpi/bin/mpicxx \
    -D CMAKE_CXX_STANDARD=14 \
    -D CMAKE_BUILD_TYPE=Release \
    -D HDF5_DIRECTORY=/opt/hdf5 \
    -D HDF5_LIB=/opt/hdf5/lib/libhdf5.a \
    -D SILO_DIRECTORY=/opt/silo \
    -D SILO_LIB=/opt/silo/lib/libsiloh5.a \
    -D USE_SILO=1 \
    -D USE_CUDA=0 \
    /path/to/LBPM

make -j4 && make install
```

---

## GPU 支持

### CUDA (NVIDIA GPU)

```bash
# 检查 CUDA 安装
nvcc --version
nvidia-smi

# 配置 CUDA 支持
cmake \
    -D CMAKE_C_COMPILER=mpicc \
    -D CMAKE_CXX_COMPILER=mpicxx \
    -D CMAKE_CXX_STANDARD=14 \
    -D CMAKE_BUILD_TYPE=Release \
    -D USE_CUDA=1 \
    -D CMAKE_CUDA_COMPILER=/usr/local/cuda/bin/nvcc \
    -D CUDA_FLAGS="-arch sm_80" \
    -D CUDA_HOST_COMPILER=/usr/bin/gcc \
    /path/to/LBPM

make -j4 && make install
```

**常见 GPU 架构代码:**
- RTX 30xx 系列: `-arch sm_86`
- RTX 40xx 系列: `-arch sm_89`
- A100: `-arch sm_80`
- V100: `-arch sm_70`
- P100: `-arch sm_60`

查看你的 GPU 架构：
```bash
nvidia-smi --query-gpu=compute_cap --format=csv
```

### HIP (AMD GPU)

```bash
# 检查 ROCm/HIP 安装
hipcc --version
rocm-smi

# 配置 HIP 支持
cmake \
    -D CMAKE_C_COMPILER=mpicc \
    -D CMAKE_CXX_COMPILER=mpicxx \
    -D CMAKE_CXX_STANDARD=14 \
    -D CMAKE_BUILD_TYPE=Release \
    -D USE_HIP=1 \
    -D CMAKE_HIP_ARCHITECTURES=gfx90a \
    /path/to/LBPM

make -j4 && make install
```

---

## 常见问题

### 1. 找不到 MPI 编译器

**问题:**
```
CMake Error: Could not find mpicc or mpicxx
```

**解决方案:**
```bash
# 查找 MPI 安装位置
find /usr -name mpicc 2>/dev/null

# 手动指定路径
cmake -D CMAKE_C_COMPILER=/usr/bin/mpicc \
      -D CMAKE_CXX_COMPILER=/usr/bin/mpicxx \
      ...
```

### 2. 找不到 HDF5

**问题:**
```
Could NOT find HDF5
```

**解决方案:**
```bash
# 查找 HDF5 安装位置
dpkg -L libhdf5-dev | grep include

# 手动指定 HDF5 路径
cmake -D HDF5_DIRECTORY=/usr/lib/x86_64-linux-gnu/hdf5/openmpi \
      -D HDF5_LIB=/usr/lib/x86_64-linux-gnu/hdf5/openmpi/libhdf5.so \
      ...
```

### 3. SILO 找不到

**问题:**
```
Could NOT find SILO
```

**解决方案 1:** 禁用 SILO
```bash
cmake -D USE_SILO=0 ...
```

**解决方案 2:** 手动编译 SILO
```bash
# 下载并编译 SILO
wget https://github.com/LLNL/Silo/releases/download/v4.11/silo-4.11.tar.gz
tar xzf silo-4.11.tar.gz
cd silo-4.11
./configure --prefix=/opt/silo --with-hdf5=/usr/include/hdf5/openmpi,/usr/lib/x86_64-linux-gnu/hdf5/openmpi
make && sudo make install

# 使用编译的 SILO
cmake -D SILO_DIRECTORY=/opt/silo \
      -D SILO_LIB=/opt/silo/lib/libsiloh5.a \
      ...
```

### 4. C++ 标准版本错误

**问题:**
```
error: 'auto' type specifier is a C++11 extension
```

**解决方案:**
```bash
# 确保使用 C++14 或更高
cmake -D CMAKE_CXX_STANDARD=14 ...

# 或者手动指定编译标志
cmake -D CMAKE_CXX_FLAGS="-std=c++14" ...
```

### 5. 链接错误 (undefined reference)

**问题:**
```
undefined reference to `H5Fcreate'
```

**解决方案:**
```bash
# 清理构建目录重新编译
cd ../LBPM-build
rm -rf *
../LBPM/sample_scripts/configure_desktop
make -j4 && make install
```

### 6. 在源码目录中构建

**问题:**
```
Building code in place is a bad idea
```

**解决方案:**
```bash
# 必须在独立目录构建
mkdir ../LBPM-build
cd ../LBPM-build
cmake /path/to/LBPM
```

---

## 测试验证

### 运行所有测试

```bash
cd LBPM-build
ctest
```

### 运行特定测试

```bash
# 查看所有测试
ctest -N

# 运行特定测试
ctest -R TestDatabase

# 详细输出
ctest -V -R TestDatabase
```

### 并行测试

```bash
# 使用 MPI 运行测试
mpirun -np 4 ./tests/lbpm_color_simulator example.db

# 在 1/2/4 进程上测试
ctest -R TestComm
```

### 验证安装

```bash
# 检查生成的可执行文件
ls tests/lbpm_*_simulator

# 检查库文件
ls lib/liblbpm-wia.*

# 检查头文件
ls include/
```

---

## 编译选项参考

### CMake 主要选项

| 选项 | 默认值 | 说明 |
|------|--------|------|
| `CMAKE_BUILD_TYPE` | Release | Debug/Release/RelWithDebInfo |
| `CMAKE_CXX_STANDARD` | 14 | C++ 标准版本 (14/17/20) |
| `USE_CUDA` | 0 | 启用 CUDA 支持 |
| `USE_HIP` | 0 | 启用 HIP 支持 |
| `USE_SILO` | 1 | 启用 SILO 可视化 |
| `USE_NETCDF` | 0 | 启用 NetCDF 支持 |
| `USE_TIMER` | 0 | 启用性能分析 |
| `USE_DOXYGEN` | 1 | 生成 API 文档 |

### Make 目标

| 命令 | 说明 |
|------|------|
| `make` | 编译所有目标 |
| `make -j4` | 使用 4 线程并行编译 |
| `make install` | 安装到指定目录 |
| `make test` 或 `ctest` | 运行测试 |
| `make doc` | 生成文档 |
| `make clean` | 清理编译文件 |
| `make build-test` | 只构建测试，不运行 |
| `make build-examples` | 构建示例程序 |

---

## 高级配置

### 自定义安装路径

```bash
cmake \
    -D CMAKE_INSTALL_PREFIX=/opt/lbpm \
    -D LBPM_INSTALL_DIR=/opt/lbpm \
    ...
```

### 调试模式编译

```bash
cmake \
    -D CMAKE_BUILD_TYPE=Debug \
    -D CMAKE_C_FLAGS="-g -O0" \
    -D CMAKE_CXX_FLAGS="-g -O0" \
    ...
```

### 启用代码覆盖率

```bash
cmake \
    -D CMAKE_BUILD_TYPE=Debug \
    -D CMAKE_CXX_FLAGS="-g -O0 --coverage" \
    ...
```

### 静态链接

```bash
cmake \
    -D BUILD_SHARED_LIBS=OFF \
    -D HDF5_LIB=/path/to/libhdf5.a \
    -D SILO_LIB=/path/to/libsiloh5.a \
    ...
```

---

## 超级计算机配置

项目在 `sample_scripts/` 目录提供了多个 HPC 系统的配置脚本：

- `configure_summit` - ORNL Summit (NVIDIA V100)
- `configure_crusher_hip` - OLCF Crusher (AMD MI250X)
- `configure_spock_hip` - OLCF Spock (AMD MI100)
- `configure_titan_jem` - ORNL Titan (NVIDIA K20X)

使用方法：

```bash
cd LBPM-build
/path/to/LBPM/sample_scripts/configure_summit
make -j16 && make install
```

---

## 文档生成

### 生成 Doxygen 文档

```bash
# 1. 安装 Doxygen
sudo apt install doxygen graphviz

# 2. 启用 Doxygen 并编译
cmake -D USE_DOXYGEN=1 /path/to/LBPM
make doc

# 3. 查看文档
firefox doc/html/index.html
```

### 生成 Sphinx 文档

```bash
# 1. 安装依赖
pip install Sphinx sphinx-rtd-theme breathe
sudo apt install dvipng texlive-latex-extra

# 2. 生成 Doxygen XML
cmake -D USE_DOXYGEN=1 /path/to/LBPM
make doc

# 3. 生成 HTML
cd /path/to/LBPM/docs
make html

# 4. 查看
firefox build/html/index.html
```

---

## 故障排查清单

1. **检查依赖版本**
   ```bash
   cmake --version  # >= 3.9
   gcc --version    # 支持 C++14
   mpicc --version
   ```

2. **清理并重新配置**
   ```bash
   cd LBPM-build
   rm -rf *
   cmake /path/to/LBPM ...
   ```

3. **查看详细编译输出**
   ```bash
   make VERBOSE=1
   ```

4. **检查 CMake 缓存**
   ```bash
   ccmake .  # 交互式查看/修改 CMake 变量
   ```

5. **查看配置日志**
   ```bash
   cat CMakeFiles/CMakeOutput.log
   cat CMakeFiles/CMakeError.log
   ```

---

## 相关资源

- **项目主页**: [LBPM GitHub](https://github.com/OPM/LBPM)
- **问题反馈**: GitHub Issues
- **文档**: `docs/` 目录
- **示例**: `example/` 目录
- **测试**: `tests/` 目录

---

## 快速参考

### 最小配置（无 GPU）

```bash
mkdir build && cd build
cmake -D CMAKE_C_COMPILER=mpicc \
      -D CMAKE_CXX_COMPILER=mpicxx \
      -D USE_CUDA=0 -D USE_SILO=0 \
      /path/to/LBPM
make -j4 && make install
```

### GPU 配置 (CUDA)

```bash
cmake -D USE_CUDA=1 \
      -D CUDA_FLAGS="-arch sm_80" \
      /path/to/LBPM
```

### 完整功能配置

```bash
cmake -D CMAKE_BUILD_TYPE=Release \
      -D USE_CUDA=1 \
      -D USE_SILO=1 \
      -D USE_NETCDF=1 \
      -D USE_TIMER=1 \
      /path/to/LBPM
```

---

**编译愉快！如有问题，请查阅上述故障排查章节或提交 Issue。**
